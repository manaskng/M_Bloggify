<div class="card h-100 shadow-sm border-0 blog-card">

  <!-- Cover -->
  <% if (blog.coverImageURL) { %>
    <% if (blog.coverImageURL.endsWith(".mp4")) { %>
      <video class="card-img-top" controls>
        <source src="<%= blog.coverImageURL %>" type="video/mp4" />
      </video>
    <% } else { %>
      <img src="<%= blog.coverImageURL %>" class="card-img-top" />
    <% } %>
  <% } else { %>
    <img src="/images/blog.png" class="card-img-top" />
  <% } %>

  <div class="card-body d-flex flex-column">

    <h5 class="card-title fw-semibold">
      <%= blog.title %>
    </h5>

    <p class="card-text text-secondary">
      <%= blog.body.substring(0, 140) %>...
    </p>

    <div class="mt-auto d-flex flex-wrap gap-2 align-items-center">

      <a href="/blog/<%= blog._id %>" class="btn btn-sm btn-primary">
        Read More
      </a>

      <% if (user) { 
        const alreadyEndorsed =
          blog.endorsedBy?.some(
            id => id.toString() === user._id.toString()
          );
      %>
        <form class="endorse-form" data-blog-id="<%= blog._id %>">
          <button
            type="submit"
            class="btn btn-sm <%= alreadyEndorsed ? 'btn-secondary disabled' : 'btn-outline-primary' %>"
          >
            ğŸŒŸ
            <span class="badge bg-dark endorse-count">
              <%= blog.endorses || 0 %>
            </span>
          </button>
        </form>
      <% } %>

      <% if (user && blog.createdBy._id.toString() === user._id.toString()) { %>

        <a href="/blog/edit/<%= blog._id %>" class="btn btn-sm btn-outline-success">
          âœï¸ Edit
        </a>

        <form
          action="/blog/delete/<%= blog._id %>"
          method="POST"
          onsubmit="return confirm('Are you sure you want to delete this blog?');"
        >
          <button type="submit" class="btn btn-sm btn-outline-danger">
            ğŸ—‘ï¸ Delete
          </button>
        </form>

      <% } %>

    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".endorse-form").forEach(form => {
      form.addEventListener("submit", async function (e) {
        e.preventDefault();

        const blogId = this.dataset.blogId;
        const button = this.querySelector("button");
        const badge = this.querySelector(".endorse-count");

        try {
          const res = await fetch(`/blog/${blogId}/endorse`, {
            method: "POST"
          });
          const data = await res.json();

          if (data.endorsed) {
            button.classList.remove("btn-outline-primary");
            button.classList.add("btn-secondary", "disabled");
            badge.innerText = data.count;
          }
        } catch (err) {
          console.error("Endorse failed", err);
        }
      });
    });
  });
</script>
